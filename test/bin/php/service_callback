#! /bin/bash
#
# Service callbacks for php container
#
# *  restart      Issue USR2 to php-fpm process to restart
# *  task [n]     Call the forum tasking service task (default 1 time)

case "$1" in
  restart)
    kill -USR2 1 ;;

  task)
    #
    # The task.php needs a task key that is fetched from core_sys_conf_settings.
    #
    opts='-d memory_limit=-1 -d max_execution_time=0'
    tasker=applications/core/interface/task/task.php
    getKey=$(cat <<-'EOD'
      require 'conf_global.php'; extract($INFO); $p = intval($sql_port);
      echo ((new mysqli( $sql_host, $sql_user, $sql_pass, $sql_database, $p, NULL))->
                query("select conf_value from core_sys_conf_settings
                        where conf_key='task_cron_key'")->fetch_row()[0]);
EOD
    )
    TASK_KEY=$(php -r "$getKey" 2>/dev/null)
    [[ "$TASK_KEY" ]] || exit
    
    for ((i=${2:-1}; i>0; i=i-1)); do
      php $ops $tasker $TASK_KEY
      ((i>0));sleep 2
    done ;;

  *)
     ;;
esac